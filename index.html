<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cámara Web Simplificada</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* BASE Y ESTRUCTURA GENERAL */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* CONTENEDOR PRINCIPAL: Flex para separar video y controles */
        .camera-app-container {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ÁREA DE VIDEO: Ocupa el espacio restante */
        .video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #video {
            display: block;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover; /* Llena el espacio */
        }
        
        /* BARRA SUPERIOR */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: center; /* Centrar mensaje */
            align-items: center;
            z-index: 10;
        }
        #message {
            font-size: 0.9em; margin: 0;
        }
        .msg-success { color: #8bc34a; }
        .msg-error { color: #ef5350; }
        .msg-info { color: #64b5f6; }

        /* CONTROLES INFERIORES: Más centrados y limpios */
        .bottom-controls {
            flex-shrink: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 0;
            box-sizing: border-box;
            display: flex;
            justify-content: center; /* Centrar todos los elementos */
            align-items: center;
            z-index: 100;
        }
        .control-button {
            background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 10px; transition: color 0.3s ease;
        }
        
        /* Botón de Captura Central */
        #snapButton {
            width: 70px; height: 70px; border-radius: 50%; background-color: #fff; border: 5px solid rgba(255, 255, 255, 0.5); display: flex; align-items: center; justify-content: center; margin: 0 40px; /* Margen para separarlo del botón de volteo */ box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); transition: transform 0.2s ease;
        }
        #snapButton:active {
             transform: scale(0.95);
        }
        #snapButton i {
            color: #dc3545; font-size: 1.5em;
        }
        
        /* Botón de Volteo a la Derecha */
        #flipButton {
             margin-right: 0; /* Asegura que se pegue al borde derecho visualmente */
             font-size: 1.5em;
             color: #ccc;
        }
        
        /* VISTA PREVIA FLOTANTE */
        #output-preview {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200;
        }
        #output-preview img {
            max-width: 90%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .preview-controls {
            margin-top: 20px; display: flex; gap: 20px;
        }
        .preview-button {
            padding: 10px 20px; font-size: 1.1em; border-radius: 50px; border: none; color: white; cursor: pointer; transition: background-color 0.3s ease;
        }
        #downloadButton { background-color: #28a745; }
        #closePreviewButton { background-color: #6c757d; }

        /* CLASES AUXILIARES */
        #canvas { display: none; }
        #video.mirrored { transform: scaleX(-1); }
    </style>
</head>
<body>

    <div class="camera-app-container">
        
        <div id="top-bar">
            <span id="message" class="msg-info">Iniciando...</span>
        </div>

        <div class="video-wrapper">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="bottom-controls">
            <div style="width: 70px; height: 70px;"></div> 
            
            <button id="snapButton"><i class="fas fa-camera"></i></button>
            
            <button id="flipButton" class="control-button" style="display: none;"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>

    <div id="output-preview">
        <img id="photo-preview" alt="Foto Capturada">
        <div class="preview-controls">
            <button id="downloadButton" class="preview-button"><i class="fas fa-download"></i> Descargar</button>
            <button id="closePreviewButton" class="preview-button"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoPreview = document.getElementById('photo-preview');
        const snapButton = document.getElementById('snapButton');
        const flipButton = document.getElementById('flipButton');
        const downloadButton = document.getElementById('downloadButton');
        const closePreviewButton = document.getElementById('closePreviewButton');
        const message = document.getElementById('message');
        const outputPreview = document.getElementById('output-preview');

        let currentStream = null;
        let facingMode = 'user';
        let hasMultipleCameras = false;
        let lastPhotoDataURL = '';

        // 1. FUNCIÓN PARA ACTUALIZAR EL MENSAJE
        function updateMessage(text, type = 'info') {
            message.textContent = text;
            message.className = `msg-${type}`;
        }

        // 2. FUNCIÓN PARA INICIAR O CAMBIAR LA CÁMARA
        async function startCamera(mode) {
            updateMessage("Solicitando permisos...", 'info');

            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: mode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false 
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                video.play();
                updateMessage(`Cámara ${mode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
                
                video.classList.toggle('mirrored', mode === 'user');

                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(device => device.kind === 'videoinput');
                hasMultipleCameras = videoInputs.length > 1;
                flipButton.style.display = hasMultipleCameras ? 'inline-block' : 'none';

            } catch (err) {
                updateMessage("Error: No se pudo iniciar. Recuerda usar HTTPS y dar permisos. Detalle: " + err.name, 'error');
                console.error("Error al acceder a la cámara:", err);
            }
        }

        // 3. FUNCIÓN PARA TOMAR LA FOTO
        function takePicture() {
            if (!currentStream || video.videoWidth === 0) {
                updateMessage("La cámara no está activa o lista.", 'error');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext('2d');
            
            // Corrección de espejo en la captura
            if (facingMode === 'user') {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (facingMode === 'user') {
                context.setTransform(1, 0, 0, 1, 0, 0);
            }

            lastPhotoDataURL = canvas.toDataURL('image/png');
            photoPreview.setAttribute('src', lastPhotoDataURL);
            outputPreview.style.display = 'flex';
            
            updateMessage("¡Foto capturada!", 'success');
        }

        // 4. FUNCIÓN PARA VOLTEAR LA CÁMARA (FRONTAL/TRASERA)
        function flipCamera() {
            if (!hasMultipleCameras) return;
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            startCamera(facingMode);
        }

        // 5. EVENT LISTENERS
        snapButton.addEventListener('click', takePicture);
        flipButton.addEventListener('click', flipCamera);
        
        // Simular descarga de foto
        downloadButton.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = lastPhotoDataURL;
            a.download = 'foto_webcam.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            outputPreview.style.display = 'none';
            updateMessage(`Cámara ${facingMode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
        });

        closePreviewButton.addEventListener('click', () => {
            outputPreview.style.display = 'none';
            updateMessage(`Cámara ${facingMode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
        });

        // Iniciar al cargar
        startCamera(facingMode);
    </script>

</body>
</html>
