<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cámara Web Nativa</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* BASE Y RESETEO */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000; /* Fondo oscuro como una app de cámara */
            color: #fff;
            overflow: hidden; /* Evita scrolls no deseados */
            display: flex;
            flex-direction: column;
            height: 100vh; /* Altura completa de la ventana */
        }

        /* CONTENEDOR PRINCIPAL DE LA CÁMARA */
        .camera-app-container {
            flex-grow: 1; /* Ocupa el espacio disponible */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra horizontalmente el video */
            justify-content: center; /* Centra verticalmente el video */
            background-color: #000;
        }

        /* ÁREA DE VIDEO */
        .video-wrapper {
            position: relative; /* Para posicionar el video */
            width: 100%;
            max-height: 100%;
            overflow: hidden;
            display: flex; /* Para centrar el video dentro del wrapper */
            align-items: center;
            justify-content: center;
        }
        #video {
            display: block;
            width: 100%; /* El video intentará ocupar el 100% del ancho */
            height: auto;
            max-height: 100%; /* Pero se limitará a la altura del wrapper */
            object-fit: contain; /* Ajusta el video para que quepa sin recortar */
            transform: scaleX(1); /* Predeterminado */
        }
        
        /* Barrita superior con mensaje */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.4); /* Semitransparente */
            padding: 8px 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        #message {
            font-size: 0.9em;
            margin: 0;
            color: #fff;
        }
        .msg-success { color: #8bc34a; } /* Verde claro */
        .msg-error { color: #ef5350; } /* Rojo claro */
        .msg-info { color: #64b5f6; } /* Azul claro */

        /* CONTROLES INFERIORES FLOTANTES */
        .bottom-controls {
            width: 100%;
            background: rgba(0, 0, 0, 0.7); /* Fondo oscuro semitransparente */
            padding: 15px 0;
            box-sizing: border-box;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100; /* Asegura que esté por encima de todo */
        }
        .control-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em; /* Tamaño de icono */
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s ease;
        }
        .control-button:hover {
            color: #ccc;
        }
        #snapButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #fff; /* Círculo blanco */
            border: 5px solid rgba(255, 255, 255, 0.5); /* Anillo exterior */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease;
        }
        #snapButton:hover {
            transform: scale(0.95);
        }
        #snapButton i {
            color: #dc3545; /* Icono de cámara dentro del botón blanco */
            font-size: 1.5em;
        }

        /* ÁREA DE CAPTURA (después de tomar foto) */
        #output-preview {
            position: fixed; /* Flotante sobre todo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none; /* Oculto por defecto */
        }
        #output-preview img {
            max-width: 90%;
            max-height: 80vh; /* Ajuste para dejar espacio a los botones */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .preview-controls {
            margin-top: 20px;
            display: flex;
            gap: 20px;
        }
        .preview-button {
            padding: 10px 20px;
            font-size: 1.1em;
            border-radius: 50px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #downloadButton {
            background-color: #28a745; /* Verde */
        }
        #downloadButton:hover {
            background-color: #218838;
        }
        #closePreviewButton {
            background-color: #6c757d; /* Gris */
        }
        #closePreviewButton:hover {
            background-color: #545b62;
        }

        /* OCULTAR ELEMENTOS AUXILIARES */
        #canvas {
            display: none;
        }
        #video.mirrored {
            transform: scaleX(-1); /* Reflejar video para selfie */
        }

        /* ICONOS ESPECÍFICOS PARA MÓVILES (barra superior) */
        .top-icon {
            font-size: 1.2em;
            color: #fff;
            margin: 0 5px;
        }
    </style>
</head>
<body>

    <div class="camera-app-container">
        
        <div id="top-bar">
            <span id="message" class="msg-info">Iniciando...</span>
            <div>
                <i class="fas fa-flash top-icon"></i> 
                <i class="fas fa-cog top-icon"></i>
            </div>
        </div>

        <div class="video-wrapper">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <canvas id="canvas"></canvas>

        <div class="bottom-controls">
            <button id="galleryButton" class="control-button"><i class="fas fa-image"></i></button>
            <button id="snapButton"><i class="fas fa-camera"></i></button>
            <button id="flipButton" class="control-button" style="display: none;"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>

    <div id="output-preview">
        <img id="photo-preview" alt="Foto Capturada">
        <div class="preview-controls">
            <button id="downloadButton" class="preview-button"><i class="fas fa-download"></i> Descargar</button>
            <button id="closePreviewButton" class="preview-button"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoPreview = document.getElementById('photo-preview'); // Renombrado
        const snapButton = document.getElementById('snapButton');
        const flipButton = document.getElementById('flipButton');
        const downloadButton = document.getElementById('downloadButton');
        const closePreviewButton = document.getElementById('closePreviewButton');
        const message = document.getElementById('message');
        const outputPreview = document.getElementById('output-preview');

        let currentStream = null;
        let facingMode = 'user'; // 'user' (frontal) o 'environment' (trasera)
        let hasMultipleCameras = false; // Para detectar si mostrar el botón de voltear
        let lastPhotoDataURL = ''; // Para guardar la última foto tomada

        // 1. FUNCIÓN PARA ACTUALIZAR EL MENSAJE
        function updateMessage(text, type = 'info') {
            message.textContent = text;
            message.className = `msg-${type}`;
        }

        // 2. FUNCIÓN PARA INICIAR O CAMBIAR LA CÁMARA
        async function startCamera(mode) {
            updateMessage("Solicitando permisos...", 'info');

            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: mode,
                    width: { ideal: 1920 }, // Mayor resolución para captura
                    height: { ideal: 1080 }
                },
                audio: false 
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                video.play();
                updateMessage(`Cámara ${mode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
                
                // Reflejar el video si es cámara frontal para la vista previa
                video.classList.toggle('mirrored', mode === 'user');

                // Detectar si hay más de una cámara y mostrar/ocultar el botón de voltear
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(device => device.kind === 'videoinput');
                hasMultipleCameras = videoInputs.length > 1;
                flipButton.style.display = hasMultipleCameras ? 'inline-block' : 'none';

            } catch (err) {
                updateMessage("Error: Asegúrate de usar HTTPS y otorgar permiso. Detalle: " + err.name, 'error');
                console.error("Error al acceder a la cámara:", err);
            }
        }

        // 3. FUNCIÓN PARA TOMAR LA FOTO
        function takePicture() {
            if (!currentStream || video.videoWidth === 0) {
                updateMessage("La cámara no está activa o lista.", 'error');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext('2d');
            
            // Si es la cámara frontal (user), volteamos la imagen horizontalmente en el canvas para la captura final
            if (facingMode === 'user') {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Restablecer la transformación del canvas
            if (facingMode === 'user') {
                context.setTransform(1, 0, 0, 1, 0, 0);
            }

            lastPhotoDataURL = canvas.toDataURL('image/png'); // Guarda la foto
            photoPreview.setAttribute('src', lastPhotoDataURL);
            outputPreview.style.display = 'flex'; // Muestra la vista previa
            
            updateMessage("¡Foto capturada!", 'success');
        }

        // 4. FUNCIÓN PARA VOLTEAR LA CÁMARA (FRONTAL/TRASERA)
        function flipCamera() {
            if (!hasMultipleCameras) return; // No hacer nada si solo hay una cámara
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            startCamera(facingMode);
        }

        // 5. EVENT LISTENERS
        snapButton.addEventListener('click', takePicture);
        flipButton.addEventListener('click', flipCamera);
        
        downloadButton.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = lastPhotoDataURL;
            a.download = 'foto_webcam.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        closePreviewButton.addEventListener('click', () => {
            outputPreview.style.display = 'none'; // Oculta la vista previa
            updateMessage(`Cámara ${facingMode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success'); // Vuelve al mensaje normal
        });

        // Iniciar la cámara por defecto (frontal) al cargar
        startCamera(facingMode);
    </script>

</body>
</html>
