<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cámara Web Vertical Modular</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* BASE Y ESTRUCTURA GENERAL */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* CONTENEDOR PRINCIPAL: Flex para separar barras y video */
        .camera-app-container {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            position: relative;
            /* Padding para las barras superior e inferior fijas */
            padding-top: 50px; 
            padding-bottom: 120px; 
        }

        /* ÁREA DE VIDEO: Ocupa el espacio restante en el centro */
        .video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            z-index: 5;
        }
        #video {
            display: block;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover; /* Llena el espacio */
        }
        
        /* MÓDULO SUPERIOR: Opciones (Flash, HDR, etc.) */
        .top-module {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000; /* Alta prioridad */
        }
        
        /* MÓDULO INFERIOR: Captura y Modos */
        .bottom-module {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px; /* Más alto para modos y botón */
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            z-index: 1000; /* Alta prioridad */
        }
        
        /* CONTROLES PRINCIPALES (Fila de Botón de Captura) */
        .main-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            padding: 0 15px;
        }

        /* Botón de Captura Central */
        #snapButton {
            width: 65px; height: 65px; border-radius: 50%; background-color: #fff; border: 5px solid rgba(255, 255, 255, 0.5); display: flex; align-items: center; justify-content: center; margin: 0; box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); transition: transform 0.2s ease;
        }
        #snapButton i {
            color: #dc3545; font-size: 1.5em;
        }
        #snapButton:active {
             transform: scale(0.95);
        }

        /* Botones de Iconos Laterales (Flash/Flip/Miniaturas) */
        .control-icon-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .preview-mini-button {
            background: #444;
            border: 1px solid white;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            overflow: hidden;
            display: block;
        }
        .preview-mini-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Selector de Modo (Fila de abajo) */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .mode-button {
            background: none;
            color: #ccc;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 50px;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
        }
        .mode-button.active {
            color: #fff;
            position: relative;
        }
        .mode-button.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: #fff;
            border-radius: 50%;
        }

        /* Mensaje de Estado Flotante */
        #message {
            position: absolute;
            top: 55px; /* Justo debajo de la barra superior */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 5px;
            z-index: 10;
        }
        .msg-success { color: #8bc34a; }
        .msg-error { color: #ef5350; }
        .msg-info { color: #64b5f6; }

        /* VISTA PREVIA FLOTANTE */
        #output-preview {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; 
        }
        #output-preview img {
            max-width: 90%; max-height: 80vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .preview-controls {
            margin-top: 20px; display: flex; gap: 20px;
        }
        .preview-button {
            padding: 10px 20px; font-size: 1.1em; border-radius: 50px; border: none; color: white; cursor: pointer; transition: background-color 0.3s ease;
        }
        #downloadButton { background-color: #28a745; }
        #closePreviewButton { background-color: #6c757d; }

        /* CLASES AUXILIARES */
        #canvas { display: none; }
        #video.mirrored { transform: scaleX(-1); }
    </style>
</head>
<body>

    <div class="camera-app-container">
        
        <div class="video-wrapper">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
    </div>

    <div class="top-module">
        <button class="control-icon-button" title="Flash"><i class="fas fa-bolt"></i></button>
        <button class="control-icon-button" title="HDR"><i class="fas fa-sun"></i></button>
        <button class="control-icon-button" title="Configuración"><i class="fas fa-cog"></i></button>
    </div>

    <div class="bottom-module">
        
        <div class="mode-selector">
            <div class="mode-button">Vídeo</div>
            <div class="mode-button active" data-mode="Foto">Foto</div>
            <div class="mode-button">Retrato</div>
        </div>

        <div class="main-controls">
            <div class="preview-mini-button">
                <img id="lastPhotoMini" src="" alt="Última foto" style="display: none;">
            </div>

            <button id="snapButton"><i class="fas fa-camera"></i></button>

            <button class="control-icon-button" id="flipButton" style="display: none;" title="Voltear Cámara"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>
    
    <div id="message" class="msg-info">Iniciando...</div>


    <div id="output-preview">
        <img id="photo-preview" alt="Foto Capturada">
        <div class="preview-controls">
            <button id="downloadButton" class="preview-button"><i class="fas fa-download"></i> Descargar</button>
            <button id="closePreviewButton" class="preview-button"><i class="fas fa-times"></i> Cerrar</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photoPreview = document.getElementById('photo-preview');
        const snapButton = document.getElementById('snapButton');
        const flipButton = document.getElementById('flipButton');
        const downloadButton = document.getElementById('downloadButton');
        const closePreviewButton = document.getElementById('closePreviewButton');
        const message = document.getElementById('message');
        const outputPreview = document.getElementById('output-preview');
        const lastPhotoMini = document.getElementById('lastPhotoMini');
        const modeButtons = document.querySelectorAll('.mode-button');

        let currentStream = null;
        let facingMode = 'user';
        let hasMultipleCameras = false;
        let lastPhotoDataURL = '';

        // 1. FUNCIÓN PARA ACTUALIZAR EL MENSAJE
        function updateMessage(text, type = 'info') {
            message.textContent = text;
            message.className = `msg-${type}`;
        }

        // 2. FUNCIÓN PARA INICIAR O CAMBIAR LA CÁMARA
        async function startCamera(mode) {
            updateMessage("Solicitando permisos...", 'info');

            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: mode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false 
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                video.play();
                updateMessage(`Cámara ${mode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
                
                video.classList.toggle('mirrored', mode === 'user');

                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(device => device.kind === 'videoinput');
                hasMultipleCameras = videoInputs.length > 1;

                flipButton.style.display = hasMultipleCameras ? 'flex' : 'none';

            } catch (err) {
                updateMessage("Error: No se pudo iniciar. Recuerda usar HTTPS y dar permisos. Detalle: " + err.name, 'error');
                console.error("Error al acceder a la cámara:", err);
            }
        }

        // 3. FUNCIÓN PARA TOMAR LA FOTO
        function takePicture() {
            if (!currentStream || video.videoWidth === 0) {
                updateMessage("La cámara no está activa o lista.", 'error');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext('2d');
            
            // Corrección de espejo en la captura
            if (facingMode === 'user') {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (facingMode === 'user') {
                context.setTransform(1, 0, 0, 1, 0, 0);
            }

            lastPhotoDataURL = canvas.toDataURL('image/png');
            photoPreview.setAttribute('src', lastPhotoDataURL);
            outputPreview.style.display = 'flex';
            
            // Actualizar la miniatura
            lastPhotoMini.setAttribute('src', lastPhotoDataURL);
            lastPhotoMini.style.display = 'block';
            
            updateMessage("¡Foto capturada!", 'success');
        }

        // 4. FUNCIÓN PARA VOLTEAR LA CÁMARA (FRONTAL/TRASERA)
        function flipCamera() {
            if (!hasMultipleCameras) return;
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            startCamera(facingMode);
        }

        // 5. EVENT LISTENERS
        snapButton.addEventListener('click', takePicture);
        flipButton.addEventListener('click', flipCamera);
        
        // Simular descarga de foto
        downloadButton.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = lastPhotoDataURL;
            a.download = 'foto_webcam.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            outputPreview.style.display = 'none';
            updateMessage(`Cámara ${facingMode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
        });

        closePreviewButton.addEventListener('click', () => {
            outputPreview.style.display = 'none';
            updateMessage(`Cámara ${facingMode === 'user' ? 'Frontal' : 'Trasera'} activa.`, 'success');
        });

        // Simulación de cambio de modo (solo visual)
        modeButtons.forEach(button => {
            button.addEventListener('click', function() {
                modeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Iniciar al cargar
        startCamera(facingMode);
    </script>
</body>
</html>
